CAP 이론(CAP Theorem)은 **분산 시스템에서 일관성(Consistency), 가용성(Availability), 네트워크 분할 내성(Partition Tolerance) 중에서 두 가지만 선택할 수 있다**는 이론입니다. 이는 2000년, Eric Brewer가 제안했으며, 이후 2002년에 공식적으로 증명되었습니다.

---

## **1. CAP 이론의 세 가지 요소**
1. **일관성(Consistency)**  
   - 모든 노드가 같은 데이터를 가져야 합니다.  
   - 즉, 하나의 노드에서 데이터를 변경하면 즉시 다른 노드에도 반영되어야 합니다.  
   - 예: 은행 시스템에서 계좌 잔고가 정확히 동기화되는 것.

2. **가용성(Availability)**  
   - 모든 요청에 대해 응답할 수 있어야 합니다.  
   - 일부 노드가 장애가 발생해도 시스템이 계속 동작해야 합니다.  
   - 예: 온라인 쇼핑몰에서 특정 서버가 다운되어도 계속 주문이 가능한 경우.

3. **네트워크 분할 내성(Partition Tolerance)**  
   - 네트워크 장애(분할) 발생 시에도 시스템이 동작해야 합니다.  
   - 일부 노드 간 통신이 불가능해도 서비스가 중단되지 않아야 합니다.  
   - 예: 여러 데이터센터로 운영되는 글로벌 서비스.

---

## **2. CAP 이론에 따른 분산 시스템 분류**
CAP 이론에 따르면, 세 가지를 동시에 만족할 수 없으므로, 시스템은 보통 두 가지 속성을 선택합니다.

1. **CP 시스템 (일관성 + 네트워크 분할 내성)**
   - 네트워크 분할이 발생하면 가용성을 희생하고, 일관성을 유지하는 시스템.
   - 예: **HBase, MongoDB (강한 일관성이 필요한 경우)**
     - MongoDB는 마스터, 슬레이브로 구성됩니다. 마스터가 응답이 없으면 일정 기간, 이용 불가 상태가 되고 새로 마스터를 선출하여 이용 가능한 상태가 됩니다. 쓰기 작업이 잠시 불가능한 상태가 되기 때문에 CP 시스템이 됩니다. 

2. **AP 시스템 (가용성 + 네트워크 분할 내성)**
   - 네트워크 분할이 발생해도 가용성을 유지하고, 일관성을 일부 희생하는 시스템.
   - 예: **Cassandra, DynamoDB (빠른 응답이 중요한 경우)**
     - 카산드라는 Peer to Peer 시스템으로 개개의 노드가 읽기, 쓰기가 가능합니다. 
     - 즉 카산드라는 프라이머리 노드 없이 모든 노드가 읽기 작업과 쓰기 작업을 수행할 수 있고 복제본을 분리된 다른 노드에 저장한다. 프라이머리 노드 없이 모든 노드가 같은 작업을 수행하므로 SPF가 없다는 장점이 있다. 지정된 복제 수만큼 데이터를 시계 방향으로 인접한 노드에 복제한다.
     - 한 노드가 노드 간 통신에서 끊어진 상황을 가정해보자. 해당 노드가 다른 노드와 통신할 수 없어도 해당 노드는 여전히 읽기 작업과 쓰기 작업을 수행할 수 있으나 데이터가 다른 노드와 맞지 않는 상태, 즉 일관성이 깨진 상태가 된다. 카산드라는 이를 최종적 일관성(Eventual Consistency)를 통해 추후에 복구한다. 따라서 모든 노드간 데이터가 동기화되기 전까지 각 노드는 서로 다른 버전의 데이터를 가지고 있다. 따라서 카산드라는 일관성을 포기한 대신 높은 가용성을 확보한 AP 시스템으로 분류된다.

3. **CA 시스템 (일관성 + 가용성)**
   - 이론적으로 존재할 수 없으며, 네트워크 분할이 발생하지 않는 이상적인 환경에서만 가능.
   - 현실적으로 모든 시스템은 네트워크 분할 내성을 어느 정도 고려해야 하므로, 실제로 구현된 사례는 없음.

---

## **3. CAP 이론이 주는 교훈**
- **완벽한 시스템은 없다.**  
  분산 시스템에서는 항상 **일관성 vs 가용성** 중 하나를 타협해야 한다.
- **현대 분산 시스템에서는 CP 또는 AP 모델을 선택해야 한다.**  
  - 금융 시스템은 **CP** 모델을 선택하여 데이터 정합성을 유지.
  - SNS나 캐시 시스템은 **AP** 모델을 선택하여 빠른 응답을 제공.
- **PACELC 이론**  
  CAP 이론을 보완하여 네트워크가 정상일 때(ELSE) 시스템이 일관성(C)과 지연 시간(Latency) 중 무엇을 우선할 것인가를 추가로 고려하는 이론.

---

### **CAP 이론의 실전 적용**
- **강한 일관성이 필요한 경우**: CP 선택 → HBase, MongoDB  
- **높은 가용성이 중요한 경우**: AP 선택 → Cassandra, DynamoDB  
- **적절한 트레이드오프를 조절하는 경우**: CAP을 유연하게 조정하는 **PACELC 모델** 고려

CAP 이론은 분산 시스템 설계를 할 때 매우 중요한 개념이므로, 각 시스템이 어떤 특성을 갖는지 이해하는 것이 중요합니다! 🚀